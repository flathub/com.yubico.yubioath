app-id: com.yubico.yubioath
runtime: org.kde.Platform
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
runtime-version: 5.15-21.08
command: yubioath-desktop
cleanup:
  - /bin/pcsc-spy
  - /include
  - /lib/pkgconfig
  - /share/doc
  - /share/man
  - '*.la'
  - '*.a'
finish-args:
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pcsc
  - --share=ipc
  - --talk-name=org.kde.StatusNotifierWatcher
  - --device=all
  - --require-version=1.3.2
  - --persist=.ykman
modules:
  - shared-modules/libusb/libusb.json
  - name: pcsc-lite
    config-opts:
      - --disable-libudev
      - --disable-libsystemd
      - --without-systemdsystemunitdir
    post-install:
      - rm /app/sbin/pcscd
      - rmdir /app/sbin || true
    cleanup:
      - /lib/libpcscspy.so
      - /lib/libpcsclite.so
    sources:
      - type: archive
        url: https://pcsclite.apdu.fr/files/pcsc-lite-1.9.8.tar.bz2
        sha256: 502d80c557ecbee285eb99fe8703eeb667bcfe067577467b50efe3420d1b2289
        x-checker-data:
          type: anitya
          project-id: 2611
          url-template: https://pcsclite.apdu.fr/files/pcsc-lite-$version.tar.bz2
  - name: pyotherside
    buildsystem: qmake
    sources:
      - type: git
        url: https://github.com/thp/pyotherside.git
        tag: 1.6.0
        commit: 63eb5290d5994dc31471dd68e43805f78099c7c6
        x-checker-data:
          type: git
          tag-pattern: ([\d+]\.[\d+]\.[\d+])
      - type: patch
        path: pyotherside-install-path.patch
  - name: swig
    config-opts:
      - --without-alllang
      - --with-python3
    cleanup:
      - '*'
    sources:
      - type: archive
        url: http://download.sourceforge.net/swig/swig-4.0.2.tar.gz
        sha256: d53be9730d8d58a16bf0cbd1f8ac0c0c3e1090573168bfa151b01eb47fa906fc
        x-checker-data:
          type: anitya
          project-id: 4919
          url-template: http://download.sourceforge.net/swig/swig-$version.tar.gz
  - name: poetry-core
    buildsystem: simple
    build-commands:
      - pip3 install --prefix /app --no-deps .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/ea/47/929cccb98445b627e3a42f29290b3f6dc6c21f3dc0ba7b3bf16215298f94/poetry-core-1.1.0.tar.gz
        sha256: d145ae121cf79118a8901b60f2c951c4edcc16f55eb8aaefc156aa33aa921f07
        x-checker-data:
          type: pypi
          name: poetry-core
  - name: semantic-version
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "semantic-version" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
        sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
        x-checker-data:
          type: pypi
          name: semantic_version
  - name: pyscard
    buildsystem: simple
    build-commands:
      - pip3 install --prefix /app --no-deps .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/10/00/8dcf33f0695ea3b1eac265c95a6d61cae138eb60527d9f58d7dd7b8cc812/pyscard-2.0.3.tar.gz
        sha256: 13c3e108163fac4f1237804ed20c5b1eb1bd5d5ee3e96adb60bfb6b9122f528d
        x-checker-data:
          type: pypi
          name: pyscard
      - type: patch
        path: pyscard-include-path.patch
  - python3-tomli.json
  - python3-typing_extensions.json
  - name: python3-setuptools_rust
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/dc/20/0b16eb0dd28c3ec6fccef77230b11e4b9ec94aa7ade1c99b1ab66d237fbe/setuptools-rust-1.5.1.tar.gz
        sha256: 0e05e456645d59429cb1021370aede73c0760e9360bbfdaaefb5bced530eb9d7
        x-checker-data:
          type: pypi
          name: setuptools-rust
  - name: python3-cryptography
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-cryptography/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation --no-binary cryptography
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/5e/0b/95d387f5f4433cb0f53ff7ad859bd2c6051051cebbb564f139a999ab46de/pycparser-2.21.tar.gz
        sha256: e644fdec12f7872f86c58ff790da456218b10f863970249516d60a5eaca77206
        x-checker-data:
          type: pypi
          name: pycparser
      - type: file
        url: https://files.pythonhosted.org/packages/2b/a8/050ab4f0c3d4c1b8aaa805f70e26e84d0e27004907c5b8ecc1d31815f92a/cffi-1.15.1.tar.gz
        sha256: d400bfb9a37b1351253cb402671cea7e89bdecc294e8016a707f6d1d8ac934f9
        x-checker-data:
          type: pypi
          name: cffi
      # cyrptography 35 is too new
      - type: file
        url: https://files.pythonhosted.org/packages/cc/98/8a258ab4787e6f835d350639792527d2eb7946ff9fc0caca9c3f4cf5dcfe/cryptography-3.4.8.tar.gz
        sha256: 94cc5ed4ceaefcbe5bf38c8fba6a21fc1d365bb8fb826ea1688e3370b2e24a1c
      - pycrypto.json # regenrate on update
  - python3-yubikey-manager.json
  - name: yubioath-desktop
    buildsystem: qmake
    post-install:
      - install -Dm644 resources/com.yubico.yubioath.desktop /app/share/applications/com.yubico.yubioath.desktop
      - install -Dm644 resources/icons/com.yubico.yubioath.svg /app/share/icons/hicolor/scalable/apps/com.yubico.yubioath.svg
      - install -Dm644 resources/com.yubico.yubioath.appdata.xml /app/share/appdata/com.yubico.yubioath.appdata.xml
    sources:
      - type: archive
        url: https://developers.yubico.com/yubioath-desktop/Releases/yubioath-desktop-5.1.0.tar.gz
        sha256: 2e6f45e1e686f53e5bac057b5c3024a23d160a5997118221b94ce1dab934a1cd
        x-checker-data:
          type: rotating-url
          url: https://developers.yubico.com/yubioath-desktop/Releases/yubioath-desktop-latest.tar.gz
          pattern: https://developers.yubico.com/yubioath-desktop/Releases/yubioath-desktop-([0-9.]+).tar.gz
      - type: patch
        paths:
          - yubioath-desktop-path.patch
          - yubioath-desktop-releases.patch
          - back-port-install-fix.patch
          - fix-appdata.patch
